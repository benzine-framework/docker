name: Build PHP Vanity Tags

permissions: read-all

on:
  workflow_dispatch:
  workflow_run:
    workflows:
      - Build PHP Flavours
    branches: ["master", "feature/**"]
    types:
      - completed

concurrency:
  group: php-vanity-tags-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

jobs:
  php-vanity-tags:
    name: Vanity Tags
    runs-on: ubuntu-latest
    env:
      latest-stable-version: "8.3"
      base_tag: "ghcr.io/benzine-framework/php"
    strategy:
      fail-fast: false
      matrix:
        variant:
          - cli
          - nginx
          - apache
        output_tag:
          - "benzine/php"
          - "gone/php"
          - "ghcr.io/benzine-framework/php"
    steps:
      - name: "Setup: Login to Docker Hub"
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_PASSWORD }}

      - name: "Setup: Login to GHCR"
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: "Retag ${{ env.base_tag }}:${{ matrix.variant }}-${{ env.latest-stable-version }} to ${{ matrix.output_tag }}:${{ matrix.variant }}"
        if: ${{ github.ref == 'refs/heads/main' }}
        shell: bash
        run: |
          docker pull ${{ env.base_tag }}:${{ matrix.variant }}-${{ env.latest-stable-version }}
          docker tag ${{ env.base_tag }}:${{ matrix.variant }}-${{ env.latest-stable-version }} ${{ matrix.output_tag }}:${{ matrix.variant }}
          docker push ${{ matrix.output_tag }}:${{ matrix.variant }}
